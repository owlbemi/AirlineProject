---
title: "AirlineProject"
author: "Jake Lee"
date: "`r Sys.Date()`"
output: html_document:
  toc: true
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## References and Datasets

**Airlines Delay** - By Ulrik Thyge Pedersen (Kaggle)

<https://www.kaggle.com/datasets/ulrikthygepedersen/airlines-delay>

**Airlines Customer Satisfaction** - By Sayantan Jana (Kaggle)

<https://www.kaggle.com/datasets/sjleshrac/airlines-customer-satisfaction/data>

**Airlines Traffic Passenger Statistics** - By The Devastator (Kaggle)

<https://www.kaggle.com/datasets/thedevastator/airlines-traffic-passenger-statistics>

**Airport Code and Geographical Information** - Kaggle

<https://www.kaggle.com/datasets/jinbonnie/airport-information>

**How to scrape Google Maps** - Bernardas Ali≈°auskas

<https://scrapfly.io/blog/posts/how-to-scrape-google-maps>

## Reading Packages and Datasets

```{r}
#load required packages
library(ggplot2)
library(dplyr)
library(tidyr)
library(tidyverse)
library(plotly)
library(ggiraph)
library(gitcreds)
library(randomForest)
library(factoextra)
library(forecast)
```


```{r}
passenger_stats <- read_csv("Datasets/Air_Traffic_Passenger_Statistics.csv")
delay <- read_csv("Datasets/airlines_delay.csv")
satis <- read_csv("Datasets/invistico_Airline.csv")
```

```{r}
#show summary of each datasets
summary(passenger_stats)
summary(delay)
summary(satis)
```

## Data Cleaning Process

### Passenger Statistics

```{r}
#check for NA values
any(is.na(passenger_stats))
any(is.na(satis))
```

```{r}
#select only international flights
passenger_stats <- passenger_stats %>%
  filter(`GEO Summary` == "International") %>%
  select(-c(`Passenger Count`, `Terminal`, `Boarding Area`)) %>%
  filter(`Operating Airline` == `Published Airline`) %>%
  select(-c(`Published Airline`, `Published Airline IATA Code`, `Price Category Code`, `index`, `GEO Summary`))
```

```{r}
summary(passenger_stats)
```

### Delay Statistics

```{r}
any(is.na(delay))
```

```{r}
delay <- delay %>%
  select(-`Class`)
```

```{r}
summary(delay)
```

### Satisfaction Score

```{r}
any(is.na(satis))

colnames(satis) <- gsub(" ", "_", colnames(satis))
colnames(satis) <- gsub("-", "_", colnames(satis))

satis$satisfaction <- as.factor(satis_clean$satisfaction)
levels(satis_clean$satisfaction)
```
```{r}
satis <- satis %>%
  mutate(across(where(is.character), as.factor))
```

```{r}
satis <- satis %>%
  filter(!is.na(satisfaction)) %>%
  mutate(across(where(is.numeric), ~ ifelse(is.na(.), median(., na.rm = TRUE), .))) %>%
  mutate(across(where(is.character), ~ ifelse(is.na(.), "Unknown", .)))
```

```{r}
satis <- satis %>%
  rename(time_conv = `Departure/Arrival time convenient`)
```

## Exploratory Data Analysis (EDA)

```{r}
# Which region has the most number of passengers who got deplaned
p_deplane_region <- passenger_stats %>%
  filter(`Activity Type Code`=='Deplaned') %>%
  ggplot(aes(Year, `Adjusted Passenger Count`, color = `GEO Region`)) +
  geom_point() +
  theme_bw()

ggplotly(p_deplane_region)
```

```{r}
# Which airline has the most number of passengers who got deplaned
p_deplane_airline <- passenger_stats %>%
  filter(`Activity Type Code`=='Deplaned') %>%
  ggplot(aes(Year, `Adjusted Passenger Count`, color = `Operating Airline IATA Code`)) +
  geom_point() +
  theme_bw()

ggplotly(p_deplane_airline)
```

```{r}
passenger_stats$Month <- match(passenger_stats$Month, month.name)

p_yearly_trend <-
  ggplot(passenger_stats, mapping = aes(
    x = Month,
    y = `Adjusted Passenger Count`
  )) + 
  geom_point() +
  geom_smooth(method = "loess", fit = `Adjusted Passenger Count` ~ Month) + 
  facet_wrap(~Year, scales = 'free_y')

p_yearly_trend
```

```{r}
# Create new df to calculate total passenger count in certain years
passenger_summary <- passenger_stats %>%
  group_by(Year, Month) %>%
  summarize(`Total Passenger Count` = sum(`Adjusted Passenger Count`))
```

```{r}
total_airline <- delay %>%
  count(delay$Airline)

total_airline$per <- total_airline %>%
  summarise(per = (percent = 100 * n / sum(total_airline$n)))

colnames(total_airline) <- c('airline', 'n', 'per')
```

```{r}
airline_pie <- ggplot(total_airline, aes(x = "", y = per$per, fill = airline)) + 
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void()

airline_pie
```

```{r}
airport_loc <- read.csv('Datasets/airport_code.csv')
```

```{r}
my.world <- map_data("world")

p1 <- my.world %>% 
  ggplot(aes(x = long, y = lat)) + 
  # create a world map background
  geom_polygon(aes(group = group), 
               color = "blue", linewidth = .2, 
               show.legend = F, fill = "white") +
  
  coord_fixed(ratio = 1.2, # adjust aspect ratio
              ylim = c(-60, 90)) + # remove Antarctica 
  theme_void() + 
  theme(plot.background = element_rect(fill = "white")) 
```

```{r}
p2 <- p1 +
  geom_point(data = airport_loc, aes(x = longitude_deg, y = latitude_deg),
             color = 'yellow', size = 0.5, shape = ".", alpha = 0.6)
p2 <- p2 + labs(title = "Location of airports around the World")
```

```{r}
p2
```

```{r}
delay_topDep <- delay %>%
  count(AirportFrom, sort = TRUE) %>%
  slice(1:10)

delay_topDep

delay_topArv <- delay %>%
  count(AirportTo, sort = TRUE) %>%
  slice(1:10)

delay_topArv
```

```{r}
delayDepPlot <- ggplot(delay_topDep) +
  geom_col(aes(x = AirportFrom, y = n, fill = n >= 15000)) +
  scale_fill_manual(
    name = "Departure Count",
    values = c("FALSE" = "blue", "TRUE" = "red"),
    labels = c("Less than 15,000", "15,000 or more")
  ) +
  labs(title = "Departure Delay Count By Airports")

delayDepPlot

delayArvPlot <- ggplot(delay_topArv) +
  geom_col(aes(x = AirportTo, y = n, fill = n >= 15000)) +
  scale_fill_manual(
    name = "Arrival Count",
    values = c("FALSE" = "blue", "TRUE" = "red"),
    labels = c("Less than 15,000", "15,000 or more")
  ) +
  labs(title = "Arrival Delay Count By Airports")

delayArvPlot
```

```{r}
delay_topDep_prepared <- delay_topDep %>%
  rename(Airport = AirportFrom, DepartureCount = n) %>%
  select(Airport, DepartureCount)

delay_topArv_prepared <- delay_topArv %>%
  rename(Airport = AirportTo, ArrivalCount = n) %>%
  select(Airport, ArrivalCount)

delay_totalCount <- full_join(
  delay_topDep_prepared,
  delay_topArv_prepared,
  by = "Airport"
)

delay_totalCount
```

```{r}
delay_totalCount <- delay_totalCount %>%
  pivot_longer(
    cols = c(DepartureCount, ArrivalCount),
    names_to = "FlightType",
    values_to = "Count"
  )
```


```{r}
delay_plot <- ggplot(delay_totalCount, aes(x = Airport, y = Count, fill = FlightType)) +
  geom_col(position = "dodge") +
  labs(
    title = "Top Airports by Departure and Arrival Counts",
    x = "Airport",
    y = "Count",
    fill = "Flight Type"
  ) +
  theme_minimal()

delay_plot
```

## Relationship between Ratings and Delay Count
We will be using RSelenium for compatibility with R but scraping using Python is much easier.

**Error handling** - StackOverflow
<https://stackoverflow.com/questions/76294801/remdropen-hangs-when-using-rselenium-and-docker>

```{r}
library(RSelenium)
library(rvest)
```

```{r}
# Run Docker (Commented out to knit)
#system('docker pull selenium/standalone-chrome:4.2.2')
#system('docker run -d -p 4445:4444 -v /dev/shm:/dev/shm --platform linux/amd64 selenium/standalone-chrome:4.2.2')
```

### Scrape Function (converted the python code into R from the tutorial)

```{r}
scrape_google_maps_reviews <- function(places_to_scrape) {
  # Connect to the remote driver
  remDr <- remoteDriver(
    remoteServerAddr = "localhost",
    port = 4445L,
    browserName = "chrome"
  )
  
  # Open the browser session
  remDr$open()
  
  # Create a blank data frame to store the results
  results_df <- data.frame(
    Place = character(),
    StarRating = numeric()
  )
  
  # Loop through each place to scrape
  for (place in places_to_scrape) {
    cat("Scraping data for:", place, "\n")
    
    # Construct the search URL for Google Maps
    search_url <- paste0("https://www.google.com/maps/search/", URLencode(paste(place, " Airport")))
    
    # Navigate to the search page
    remDr$navigate(search_url)
    
    # Wait for the page to load
    Sys.sleep(5)
    
    # Get the page source and read it with rvest
    page_source <- remDr$getPageSource()[[1]]
    page_html <- read_html(page_source)
    
    # Scrape the star rating using CSS selectors
    # These selectors may change over time, so you might need to inspect the page HTML
    # and update them if they stop working.
    star_rating_raw <- page_html %>%
      html_node(".fontDisplayLarge") %>% # This is a common class for the overall rating
      html_text()
    
    # Clean and convert the star rating to a numeric value
    if (!is.null(star_rating_raw)) {
      # Use a more robust regex to extract the first occurrence of a number with an optional decimal
      star_rating <- as.numeric(str_extract(star_rating_raw, "[0-9]+\\.?[0-9]*"))
    } else {
      star_rating <- NA
    }
    
    # Add the result to the results data frame
    results_df <- bind_rows(
      results_df,
      data.frame(
        Place = place,
        StarRating = star_rating
      )
    )
  }
  
  # Close the browser session
  remDr$close()
  
  return(results_df)
}
```

### Scraping Ratings from Google Maps

```{r}
airports <- delay_topArv$AirportTo
airport_ratings <- scrape_google_maps_reviews(airports)
```
# Statistical Tests
## Correlation Test

```{r}
airport_ratings
```

```{r}
delay_traffic <- delay_totalCount %>%
  pivot_wider(names_from = FlightType, values_from = Count) %>%
  mutate(TotalDelays = ArrivalCount + DepartureCount)

airport_ratings <- airport_ratings %>%
  rename(Airport = Place)
```

```{r}
airport_full <- airport_ratings %>%
  inner_join(delay_traffic, by = "Airport")

airport_full
```

```{r}
RatingTotalNumTest <- cor.test(airport_full$StarRating, airport_full$TotalDelays)
RatingTotalNumTest

RatingDepartureNumTest <- cor.test(airport_full$StarRating, airport_full$DepartureCount)
RatingDepartureNumTest

RatingArrivalNumTest <- cor.test(airport_full$StarRating, airport_full$ArrivalCount)
RatingArrivalNumTest
```

Since the correlations (0.0987884, 0.09771506, 0.09804246) is less than 0.3, the correlation is weak.

## Linear Regression

```{r}
linearTotal <- lm(TotalDelays ~ StarRating, data = airport_full)
summary(linearTotal)
```

## Logistic Regression

```{r}
airport_full <- airport_full %>%
  mutate(HighDelay = ifelse(TotalDelays > median(TotalDelays), 1, 0))

model_log <- glm(HighDelay ~ StarRating, data = airport_full, family = "binomial")
summary(model_log)
```

## Delay ML Analysis
### Random Forest 
```{r}
airport_full <- airport_full %>%
  mutate(HighDelay = as.factor(ifelse(TotalDelays > median(TotalDelays), 1, 0)))

set.seed(runif(1000))
rf_airport <- randomForest(
  HighDelay ~ StarRating + ArrivalCount + DepartureCount + TotalDelays,
  data = airport_full,
  ntree = 500,
  importance = TRUE
)

rf_airport
varImpPlot(rf_airport)
```

```{r}
satis$satisfaction <- as.factor(satis$satisfaction)
set.seed(runif(2000))

satis_reduced <- satis %>%
  select(satisfaction, Age, Flight_Distance, Seat_comfort, time_conv, Food_and_drink,
         Gate_location, Inflight_wifi_service, Inflight_entertainment, Online_support,
         Ease_of_Online_booking, On_board_service, Leg_room_service, Baggage_handling,
         Checkin_service, Cleanliness, Online_boarding)

rf_satis <- randomForest(
  satisfaction ~ .,
  data = satis_reduced,
  ntree = 500,
  importance = TRUE
)

varImpPlot(rf_satis)

```

